# SQL 응용

## 절차형 SQL 작성

### 트리거

1. 개념
    - 미리 정해 놓은 조건이 충족되거나, 특정 테이블에 대한 이벤트가 발생할 때 마다 관련 작업이 자동으로 수행되는 절차형 SQL
2. 목적
    - 데이터 무결성 유지 및 로그 메시지 출력 등 별도 처리를 위해 사용되기도 함
3. 구성
    1. 선언부
        - 트리거 명칭 정의
    2. 이벤트부
        - 트리거 실행 타이밍, 이벤트 명시
    3. 시작/종료부 (BEGIN/END)
    4. 제어부
    5. SQL
        - DML 주로 사용, DDL도 사용
    6. 예외부
4. 주의사항
    1. TCL 사용불가
        - commit, rollback같은 TCL(트랜잭션 제어어) 사용 불가
    2. 오류에 주의
        - 트리거에서 오류 발생 시 트리거 이후 작업이 진행되지 않음 → 원자성을 보장하지 않음

### 이벤트

- 특정 시간에 특정한 쿼리, 프로시저, 함수 등을 실행시키는 기능

### 사용자 정의함수

- 절차형 SQL을 활요앟여 일련의 연산 처리 결과를 단일값으로 반환할 수 있는 함수
- 종료 시 단일 값을 반환한다. (프로시저와의 차이점)
- 트리거의 구성에서 이벤트부가 사라지고 반환부가 추가된 형태
- 외부에서의 호출을 통해 실행한다. (프로시저와 공통점)

### SQL 문법

1. 분류
    1. 데이터 정의어(DDL)
        - CREATE, ALTER, DROP, TRUNCATE
    2. 데이터 조작어(DML)
        - SELECT, INSERT, UPDATE, DELETE
    3. 데이터 제어어(DCL)
        - GRANT, REVOKE
2. LIKE와 같이 사용하는 와일드 문자
    - + : 문자열 연결
    - % : 0개 이상의 문자열과 일치
    - [ ] : 1개의 문자와 일치
    - [^] : 1개의 문자와 불일치
    - _ : 특정 위치의 1개의 문자와 일치
3. 주석처리
    - - - (double dash)
    - /* */
4. 힌트의 사용
    - - - +
    - /*+ */

## 응용 SQL 작성

### 데이터 제어어 (DCL)

1. 기능
    1. 데이터 보안
    2. 무결성 유지
    3. 병행수행 제어
        - 여러 트랜잭션을 수행할 때 일관성을 파괴하지 않도록 트랜잭션 간의 상호작용 제어
    4. 회복
        - 장애 발생 시, 장애 발생 이전의 상태로 복원하는 기능 (Rollback)
2. 유형
    1. DCL
        1. GRANT
        2. REVOKE
    2. DCL/TCL
        1. COMMIT
        2. ROLLBACK
        3. SAVEPOINT

### 윈도 함수

1. 개념
    - 행 간의 관계를 쉽게 정의하기 위해 만든 함수
2. 분류
    1. 집계 함수
        - 여러 행 또는 전체 행으로부터 하나의 결갓값 반환
        - COUNT, SUM, STDDEV(표준편차), VARIAN(분산)
    2. 순위 함수
        - 레코드 순위 계산
        - RANK(동일 순위 레코드 존재 시 후순위는 넘어감)
        - DENSE_RANK(동일 순위 레코드 존재해도 후순휘 넘어가지 않음)
        - ROW_NUMBER (줄세워서 번호 부여)
    3. 행 순서 함수
        - 레코드의 첫번째, 마지막 값
    4. 그룹 내 비율 함수
        - 백분율과 같은 비율과 관련된 통계를 보여주는 함수
3. 활용
    1. OLAP(On-Line Analytical Processing) 개념
        - 동일 데이터를 여러 기준을 이용하는 방식으로 바라보며 다차원 데이터 분석 지원 시스템
    2. OLAP 연산
        1. Roll-Up
        2. Drill-Down
        3. Slicing
        4. Dicing
        5. Pivoting

### 그룹 함수

- ROLLUP, CUBE, GROUPING SETS

### 오류 처리

- 액션, 상태 값, 명령문

# SQL 활용

## 기본 SQL 작성

### 데이터 정의어(DDL)

1. 대상
    1. 도메인
        - 하나의 속성이 가질 수 있는 원자값들의 집합
    2. 스키마
        1. 외부 스키마
            - 사용자, 개발자 관점에서 필요로 하는 데이터베이스의 논리적 구조
        2. 개념 스키마
            - 데이터베이스의 전체적인 논리적 구조
        3. 내부 스키마
            - 물리적 저장장치의 관점에서 보는 데이터베이스 구조
    3. 테이블
    4. 뷰
    5. 인덱스

### 트랜잭션

1. 특징
    1. 원자성
    2. 일관성
    3. 격리성
    4. 영속성
2. 연산 ⭐
    1. **트랜잭션 연산 (원자성)**
        1. 커밋, 롤백
    2. **병행제어 (일관성)**
        1. 목적
            - DB 공유 최대화
            - 시스템 활용도 최대화
            - DB 일관성 유지
            - 사용자 응답시간 최소화
        2. 미보장 시 문제점
            - 갱신 손실

                : 먼저 실행된 트랜잭션 결과를 나중에 실행된 트랜잭션이 덮어쓸 때 발생하는 오류

            - 현황 파악 오류

                : 트랜잭션 중간 수행 결과를 다른 트랜잭션이 참조하여 발생하는 오류

            - 모순성

                : 두 트랜잭션이 동시에 실행되어 일관성 결여되는 오류

            - 연쇄복귀

                : 복수 트랜잭션이 데이터 공유 시 특정 트랜잭션이 처리를 취소할 경우 트랜잭션이 처리한 곳의 부분을 취소하지 못하는 오류

        3. 병행제어 기법 종류
            - 로킹(Locking)

                : 트랜잭션의 순차적 진행을 보장하는 직렬화 기법, 데이터베이스/파일/레코드 등은 로킹 단위가 될 수 없음, 로킹 단위가 작아지면 DB 공유도 증가, 로킹 단위가 작아지면 로킹 오버헤드 증가

            - 낙관적 검증
            - 타임 스탬프 순서
            - 다중버전 동시성 제어
    3. **데이터베이스 고립화 수준 (격리성)**
        1. 개념
            - 데이터의 무결성을 해치지 않기 위해 잠금을 설정하는 정도
        2. 종류
            - Read Uncommitted
            - Read Committed
            - Repeatable Read
            - Serializable Read
    4. **회복 기법 (영속성)**
        1. 개념
            - 장애 발생 시 손상도기 이전의 상태로 복구시키는 작업
        2. 종류
            - 로그 기반 회복 기법

                : 지연 갱신 회복 기법, 즉각 갱신 회복 기법으로 분류됨

            - 체크 포인트 회복 기법
            - 그림자 페이징 회복 기법

                : 트랜잭션 수행 시 복제본을 생성하여 복구

3. 트랜잭션 상태 변화
    1. 활동 상태
    2. 부분완료 상태
    3. 완료 상태 : commit 후
    4. 실패 상태
    5. 철회 상태 : rollback 후

### 테이블

1. 용어
    1. 행(tuple)
    2. 열(attribute)
        - 열의 개수를 degree라고 함
    3. 식별자